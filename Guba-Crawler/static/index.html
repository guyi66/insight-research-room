<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áà¨Ëô´‰ªªÂä°Ë∞ÉÂ∫¶Á≥ªÁªü</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css" onerror="this.href='https://cdn.jsdelivr.net/npm/element-plus@2.4.4/dist/index.css'">
    <style>
        body {
            margin: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'ÂæÆËΩØÈõÖÈªë', Arial, sans-serif;
        }
        .header {
            background: linear-gradient(90deg, #409EFF 0%, #67C23A 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            border-left: 4px solid #409EFF;
        }
        .status-card.running {
            border-left-color: #67C23A;
        }
        .status-card.warning {
            border-left-color: #E6A23C;
        }
        .status-card.danger {
            border-left-color: #F56C6C;
        }
        .card-title {
            font-size: 14px;
            color: #909399;
            margin-bottom: 10px;
        }
        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #303133;
        }
        .tabs-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .config-form {
            max-width: 800px;
        }
        .json-editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending { background: #E1F3D8; color: #67C23A; }
        .status-running { background: #D1ECF1; color: #409EFF; }
        .status-completed { background: #D4EDDA; color: #28A745; }
        .status-failed { background: #F8D7DA; color: #DC3545; }
        .status-cancelled { background: #F3F4F6; color: #6C757D; }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üï∑Ô∏è Áà¨Ëô´‰ªªÂä°Ë∞ÉÂ∫¶Á≥ªÁªü</h1>
                    <p>ShengHao  V.2.1</p>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: rgba(255,255,255,0.9); font-size: 14px;">
                        Ê¨¢ËøéÔºå{{ currentUser }}
                    </span>
                    <el-button 
                        type="danger" 
                        size="small" 
                        @click="logout"
                        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;"
                    >
                        ÈÄÄÂá∫ÁôªÂΩï
                    </el-button>
                </div>
            </div>
        </div>
        
        <div class="container">
            <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü - ÁΩÆÈ°∂ -->
            <div class="tabs-container" style="margin-bottom: 30px;">
                <el-tabs v-model="activeTab" @tab-click="handleTabClick" type="border-card">
                    <el-tab-pane label="üìã ‰ªªÂä°ÈÖçÁΩÆ" name="configs"></el-tab-pane>
                    <el-tab-pane label="‚è≥ ‰ªªÂä°ÈòüÂàó" name="queue"></el-tab-pane>
                    <el-tab-pane label="üìä ÊâßË°åÂéÜÂè≤" name="history"></el-tab-pane>
                </el-tabs>
            </div>
            
            <!-- Á≥ªÁªüÁä∂ÊÄÅÂç°Áâá -->
            <div class="status-cards">
                <div class="status-card" :class="{ running: systemStatus.scheduler_running }">
                    <div class="card-title">Ë∞ÉÂ∫¶Âô®Áä∂ÊÄÅ</div>
                    <div class="card-value">
                        {{ systemStatus.scheduler_running ? 'ËøêË°å‰∏≠' : 'Â∑≤ÂÅúÊ≠¢' }}
                        <el-button 
                            :type="systemStatus.scheduler_running ? 'danger' : 'success'"
                            size="small" 
                            @click="toggleScheduler"
                            style="margin-left: 10px;"
                        >
                            {{ systemStatus.scheduler_running ? 'ÂÅúÊ≠¢' : 'ÂêØÂä®' }}
                        </el-button>
                    </div>
                </div>
                
                <div class="status-card">
                    <div class="card-title">ÂΩìÂâç‰ªªÂä°</div>
                    <div class="card-value">
                        {{ systemStatus.current_task ? systemStatus.current_task.task_name : 'Êó†' }}
                    </div>
                    <div v-if="systemStatus.current_task" style="font-size: 12px; color: #909399; margin-top: 5px;">
                        ËøêË°åÊó∂Èó¥: {{ formatDuration(systemStatus.current_task.duration_seconds) }}
                    </div>
                </div>
                
                <div class="status-card">
                    <div class="card-title">ÊéíÈòü‰ªªÂä°</div>
                    <div class="card-value">{{ (systemStatus.queue_stats && systemStatus.queue_stats.pending) || 0 }}</div>
                </div>
                
                <div class="status-card">
                    <div class="card-title">‰ªäÊó•ÂÆåÊàê</div>
                    <div class="card-value">{{ (systemStatus.today_stats && systemStatus.today_stats.completed) || 0 }}</div>
                </div>
                
                <div class="status-card" :class="{ running: fullTextStatus.is_running }">
                    <div class="card-title">ÂÖ®ÊñáÁà¨ÂèñÂô®</div>
                    <div class="card-value">
                        {{ fullTextStatus.is_running ? 'ËøêË°å‰∏≠' : 'Â∑≤ÂÅúÊ≠¢' }}
                        <el-button 
                            :type="fullTextStatus.is_running ? 'danger' : 'success'"
                            size="small" 
                            @click="toggleFullTextCrawler"
                            style="margin-left: 10px;"
                        >
                            {{ fullTextStatus.is_running ? 'ÂÅúÊ≠¢' : 'ÂêØÂä®' }}
                        </el-button>
                    </div>
                    <div style="font-size: 12px; color: #909399; margin-top: 5px;">
                        ÈòüÂàó: {{ fullTextStatus.queue_count || 0 }} | ËøõÂ∫¶: {{ fullTextStatus.progress || '0.0' }}% | Á∫øÁ®ãÊï∞: 8 
                    </div>
                </div>
            </div>
            
            <!-- Ê†áÁ≠æÈ°µÂÜÖÂÆπÂå∫Âüü -->
            <div class="tabs-container">
                <!-- ‰ªªÂä°ÈÖçÁΩÆÂÜÖÂÆπ -->
                <div v-show="activeTab === 'configs'">
                        <!-- Êñá‰ª∂Â§πÁÆ°ÁêÜÂå∫Âüü -->
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0; color: #409EFF;">üìÅ Êñá‰ª∂Â§πÁÆ°ÁêÜ</h4>
                                <el-button size="small" type="success" @click="openCreateFolderDialog">
                                    <el-icon><FolderAdd /></el-icon>
                                    Êñ∞Âª∫Êñá‰ª∂Â§π
                                </el-button>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                <el-tag 
                                    v-for="folder in taskFolders" 
                                    :key="folder.id"
                                    :type="selectedFolder === folder.id ? 'primary' : 'info'"
                                    :effect="selectedFolder === folder.id ? 'dark' : 'light'"
                                    @click="selectFolder(folder.id)"
                                    @close="deleteFolder(folder.id)"
                                    closable
                                    style="cursor: pointer; padding: 8px 12px; font-size: 13px;"
                                >
                                    üìÅ {{ folder.name }} ({{ getFolderTaskCount(folder.id) }})
                                </el-tag>
                                <el-tag 
                                    :type="selectedFolder === null ? 'primary' : 'info'"
                                    :effect="selectedFolder === null ? 'dark' : 'light'"
                                    @click="selectFolder(null)"
                                    style="cursor: pointer; padding: 8px 12px; font-size: 13px;"
                                >
                                    üìã ÂÖ®ÈÉ®‰ªªÂä° ({{ taskConfigs.length }})
                                </el-tag>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <el-button type="primary" @click="showCreateConfigDialog = true">
                                <el-icon><Plus /></el-icon>
                                Êñ∞Âª∫‰ªªÂä°ÈÖçÁΩÆ
                            </el-button>
                            <el-button @click="loadTaskConfigs">
                                <el-icon><Refresh /></el-icon>
                                Âà∑Êñ∞
                            </el-button>
                            <el-button @click="autoClassifyTasks" type="warning" size="small">
                                <el-icon><Magic /></el-icon>
                                Ëá™Âä®ÂΩíÁ±ª‰ªªÂä°
                            </el-button>
                        </div>
                        
                        <el-table :data="filteredTaskConfigs" style="width: 100%" v-loading="loading.configs">
                            <el-table-column prop="id" label="ID" width="80"></el-table-column>
                            <el-table-column prop="task_name" label="‰ªªÂä°ÂêçÁß∞" width="200"></el-table-column>
                            <el-table-column label="Êñá‰ª∂Â§π" width="120">
                                <template #default="scope">
                                    <el-tag v-if="scope.row.folder_id" size="small" type="info">
                                        üìÅ {{ getFolderName(scope.row.folder_id) }}
                                    </el-tag>
                                    <span v-else style="color: #909399; font-size: 12px;">Êú™ÂàÜÁ±ª</span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="description" label="ÊèèËø∞" show-overflow-tooltip></el-table-column>
                            <el-table-column prop="crawler_type" label="Á±ªÂûã" width="120">
                                <template #default="scope">
                                    <el-tag :type="getCrawlerTypeColor(scope.row.crawler_type)">{{ getCrawlerTypeName(scope.row.crawler_type) }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="priority" label="‰ºòÂÖàÁ∫ß" width="100"></el-table-column>
                            <el-table-column prop="is_active" label="Áä∂ÊÄÅ" width="100">
                                <template #default="scope">
                                    <el-tag :type="scope.row.is_active ? 'success' : 'danger'">
                                        {{ scope.row.is_active ? 'ÂêØÁî®' : 'Á¶ÅÁî®' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="Êìç‰Ωú" width="320">
                                <template #default="scope">
                                    <el-button size="small" @click="editConfig(scope.row)">ÁºñËæë</el-button>
                                    <el-button size="small" type="success" @click="addToQueue(scope.row.id)">Âä†ÂÖ•ÈòüÂàó</el-button>
                                    <el-dropdown size="small" style="margin-left: 5px;">
                                        <el-button size="small" type="primary">
                                            ÁßªÂä®Âà∞ <el-icon><ArrowDown /></el-icon>
                                        </el-button>
                                        <template #dropdown>
                                            <el-dropdown-menu>
                                                <el-dropdown-item @click="moveTaskToFolder(scope.row.id, null)">Êú™ÂàÜÁ±ª</el-dropdown-item>
                                                <el-dropdown-item 
                                                    v-for="folder in taskFolders" 
                                                    :key="folder.id"
                                                    @click="moveTaskToFolder(scope.row.id, folder.id)"
                                                >
                                                    üìÅ {{ folder.name }}
                                                </el-dropdown-item>
                                            </el-dropdown-menu>
                                        </template>
                                    </el-dropdown>
                                    <el-button size="small" type="danger" @click="deleteConfig(scope.row.id)">Âà†Èô§</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                </div>
                
                <!-- ‰ªªÂä°ÈòüÂàóÂÜÖÂÆπ -->
                <div v-show="activeTab === 'queue'">
                        <div style="margin-bottom: 20px;">
                            <el-button @click="loadTaskQueue">
                                <el-icon><Refresh /></el-icon>
                                Âà∑Êñ∞ÈòüÂàó
                            </el-button>
                        </div>
                        
                        <el-table :data="taskQueue" style="width: 100%" v-loading="loading.queue">
                            <el-table-column prop="queue_position" label="‰ΩçÁΩÆ" width="80"></el-table-column>
                            <el-table-column prop="task_name" label="‰ªªÂä°ÂêçÁß∞" width="200"></el-table-column>
                            <el-table-column prop="crawler_type" label="Á±ªÂûã" width="120">
                                <template #default="scope">
                                    <el-tag :type="getCrawlerTypeColor(scope.row.crawler_type)">{{ getCrawlerTypeName(scope.row.crawler_type) }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="status" label="Áä∂ÊÄÅ" width="120">
                                <template #default="scope">
                                    <span :class="'task-status status-' + scope.row.status">{{ getStatusName(scope.row.status) }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="current_step" label="ÂΩìÂâçÈò∂ÊÆµ" width="180">
                                <template #default="scope">
                                    <span style="font-size: 13px; color: #606266;">{{ scope.row.current_step || 'Á≠âÂæÖÊâßË°å...' }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="progress_percent" label="ËøõÂ∫¶" width="150">
                                <template #default="scope">
                                    <div class="progress-info">
                                        <el-progress :percentage="parseFloat(scope.row.progress_percent) || 0" :show-text="false" style="flex: 1;"></el-progress>
                                        <span style="margin-left: 10px; font-size: 12px;">{{ (parseFloat(scope.row.progress_percent) || 0).toFixed(1) }}%</span>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column prop="created_at" label="ÂÖ•ÈòüÊó∂Èó¥" width="180">
                                <template #default="scope">
                                    {{ formatDateTime2(scope.row.created_at) }}
                                </template>
                            </el-table-column>
                            <el-table-column label="Êìç‰Ωú" width="160">
                                <template #default="scope">
                                    <el-button 
                                        v-if="scope.row.status === 'pending'"
                                        size="small" 
                                        type="danger" 
                                        @click="removeFromQueue(scope.row.id)"
                                    >
                                        ÁßªÈô§
                                    </el-button>
                                    <el-button 
                                        v-if="scope.row.status === 'running' || scope.row.status === 'completed' || scope.row.status === 'failed'"
                                        size="small" 
                                        type="primary" 
                                        @click="viewTaskLog(scope.row.id)"
                                    >
                                        Êü•ÁúãÊó•Âøó
                                    </el-button>
                                    <span v-if="scope.row.status === 'pending'" style="color: #909399; font-size: 12px; margin-left: 10px;">Á≠âÂæÖ‰∏≠</span>
                                </template>
                            </el-table-column>
                        </el-table>
                </div>
                
                <!-- ÊâßË°åÂéÜÂè≤ÂÜÖÂÆπ -->
                <div v-show="activeTab === 'history'">
                        <div style="margin-bottom: 20px;">
                            <el-button @click="loadTaskHistory">
                                <el-icon><Refresh /></el-icon>
                                Âà∑Êñ∞ÂéÜÂè≤
                            </el-button>
                        </div>
                        
                        <el-table :data="taskHistory.items" style="width: 100%" v-loading="loading.history">
                            <el-table-column prop="task_name" label="‰ªªÂä°ÂêçÁß∞" width="200"></el-table-column>
                            <el-table-column prop="crawler_type" label="Á±ªÂûã" width="120">
                                <template #default="scope">
                                    <el-tag :type="getCrawlerTypeColor(scope.row.crawler_type)">{{ getCrawlerTypeName(scope.row.crawler_type) }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="status" label="Áä∂ÊÄÅ" width="100">
                                <template #default="scope">
                                    <span :class="'task-status status-' + scope.row.status">{{ getStatusName(scope.row.status) }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="duration_seconds" label="ËÄóÊó∂" width="100">
                                <template #default="scope">
                                    {{ formatDuration(scope.row.duration_seconds) }}
                                </template>
                            </el-table-column>
                            <el-table-column label="ÊâßË°åÁªìÊûú" width="200">
                                <template #default="scope">
                                    <div style="font-size: 12px;">
                                        <div>ÊàêÂäü: {{ scope.row.success_count || 0 }}</div>
                                        <div>Â§±Ë¥•: {{ scope.row.failed_count || 0 }}</div>
                                        <div>ÊÄªËÆ°: {{ scope.row.total_count || 0 }}</div>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column prop="started_at" label="ÂºÄÂßãÊó∂Èó¥" width="180">
                                <template #default="scope">
                                    {{ formatDateTime(scope.row.started_at) }}
                                </template>
                            </el-table-column>
                            <el-table-column prop="completed_at" label="ÁªìÊùüÊó∂Èó¥" width="180">
                                <template #default="scope">
                                    {{ formatDateTime(scope.row.completed_at) }}
                                </template>
                            </el-table-column>
                            <el-table-column label="Êìç‰Ωú" width="120">
                                <template #default="scope">
                                    <el-button 
                                        size="small" 
                                        type="primary" 
                                        @click="viewTaskLog(scope.row.id)"
                                    >
                                        Êü•ÁúãÊó•Âøó
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <el-pagination
                                v-model:current-page="historyPage"
                                :page-size="historyLimit"
                                :total="taskHistory.total"
                                layout="prev, pager, next, total"
                                @current-change="loadTaskHistory"
                            ></el-pagination>
                        </div>
                </div>
            </div>
        </div>
        
        <!-- ÂàõÂª∫/ÁºñËæë‰ªªÂä°ÈÖçÁΩÆÂØπËØùÊ°Ü -->
        <el-dialog 
            v-model="showCreateConfigDialog" 
            :title="editingConfig ? 'ÁºñËæë‰ªªÂä°ÈÖçÁΩÆ' : 'ÂàõÂª∫‰ªªÂä°ÈÖçÁΩÆ'"
            width="90%"
            :before-close="handleCloseConfigDialog"
        >
            <el-form :model="configForm" label-width="120px" class="config-form">
                <el-form-item label="‰ªªÂä°ÂêçÁß∞" required>
                    <el-input v-model="configForm.task_name" placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ÂêçÁß∞"></el-input>
                </el-form-item>
                
                <el-form-item label="‰ªªÂä°ÊèèËø∞">
                    <el-input v-model="configForm.description" type="textarea" :rows="2" placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ÊèèËø∞"></el-input>
                </el-form-item>
                
                <el-form-item label="Áà¨Ëô´Á±ªÂûã" required>
                    <el-select v-model="configForm.crawler_type" placeholder="ËØ∑ÈÄâÊã©Áà¨Ëô´Á±ªÂûã" @change="onCrawlerTypeChange">
                        <el-option label="Â∏ñÂ≠êÁà¨Âèñ" value="post"></el-option>
                        <el-option label="ËØÑËÆ∫Áà¨Âèñ" value="comment"></el-option>
                        <el-option label="ÂÖ®ÊñáÁà¨Âèñ" value="full_text"></el-option>
                        <el-option label="È°∫Â∫èÊâßË°å" value="sequential"></el-option>
                        <el-option label="Âπ∂Ë°åÊâßË°å" value="parallel"></el-option>
                    </el-select>
                </el-form-item>
                
                <el-form-item label="‰ºòÂÖàÁ∫ß">
                    <el-input-number v-model="configForm.priority" :min="0" :max="100"></el-input-number>
                </el-form-item>
                
                <el-form-item label="ÂêØÁî®Âπ∂Ë°å">
                    <el-switch v-model="configForm.enable_parallelism"></el-switch>
                    <span style="margin-left: 10px; color: #909399; font-size: 12px;">ÂºÄÂêØÂêéÂπ∂Ë°åÂ∫¶‰∏∫2ÔºåÂê¶Âàô‰∏∫1</span>
                </el-form-item>
                
                <!-- ÈÖçÁΩÆÊ®°ÂºèÈÄâÊã© -->
                <el-form-item label="ÈÖçÁΩÆÊ®°Âºè">
                    <el-radio-group v-model="configMode" @change="onConfigModeChange">
                        <el-radio label="form">Ë°®ÂçïÊ®°Âºè</el-radio>
                        <el-radio label="json">JSONÊ®°Âºè</el-radio>
                    </el-radio-group>
                </el-form-item>
                
                <!-- Ë°®ÂçïÊ®°ÂºèÈÖçÁΩÆ -->
                <div v-if="configMode === 'form'">
                    <el-divider content-position="left">Êï∞ÊçÆÂ∫ìÈÖçÁΩÆ</el-divider>
                    
                    <!-- MongoDBÈÖçÁΩÆ -->
                    <el-card shadow="never" style="margin-bottom: 20px;">
                        <template #header>
                            <span>MongoDB ÈÖçÁΩÆ</span>
                        </template>
                        <el-row :gutter="20">
                            <el-col :span="12">
                                <el-form-item label="‰∏ªÊú∫Âú∞ÂùÄ">
                                    <el-input v-model="formConfig.MongoDB.host" placeholder="localhost"></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="12">
                                <el-form-item label="Á´ØÂè£">
                                    <el-input-number v-model="formConfig.MongoDB.port" :min="1" :max="65535" style="width: 100%;"></el-input-number>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row :gutter="20">
                            <el-col :span="8">
                                <el-form-item label="Áî®Êà∑Âêç">
                                    <el-input v-model="formConfig.MongoDB.username" placeholder="admin"></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="ÂØÜÁ†Å">
                                    <el-input v-model="formConfig.MongoDB.password" type="password" show-password></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="Êï∞ÊçÆÂ∫ìÂêç">
                                    <el-input v-model="formConfig.MongoDB.database" placeholder="guba"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                    </el-card>
                    
                    <!-- RedisÈÖçÁΩÆ -->
                    <el-card shadow="never" style="margin-bottom: 20px;">
                        <template #header>
                            <span>Redis ÈÖçÁΩÆ</span>
                        </template>
                        <el-row :gutter="20">
                            <el-col :span="12">
                                <el-form-item label="‰∏ªÊú∫Âú∞ÂùÄ">
                                    <el-input v-model="formConfig.Redis.redis_host" placeholder="localhost"></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="12">
                                <el-form-item label="Á´ØÂè£">
                                    <el-input-number v-model="formConfig.Redis.redis_port" :min="1" :max="65535" style="width: 100%;"></el-input-number>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row :gutter="20">
                            <el-col :span="8">
                                <el-form-item label="ÂØÜÁ†Å">
                                    <el-input v-model="formConfig.Redis.redis_password" type="password" show-password></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="Êï∞ÊçÆÂ∫ì">
                                    <el-input-number v-model="formConfig.Redis.redis_db" :min="0" :max="15" style="width: 100%;"></el-input-number>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="Redis Key">
                                    <el-input v-model="formConfig.Redis.redis_key" placeholder="urls"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                    </el-card>
                    
                    <el-divider content-position="left">Áà¨Ëô´ÂèÇÊï∞ÈÖçÁΩÆ</el-divider>
                    
                    <!-- ‰∏ªÁ±ªÂèÇÊï∞ÈÖçÁΩÆ -->
                    <el-card shadow="never" style="margin-bottom: 20px;">
                        <template #header>
                            <span>‰∏ªÁ±ªÂèÇÊï∞</span>
                        </template>
                        <el-row :gutter="20">
                            <el-col :span="8">
                                <el-form-item label="ËÇ°Á•®‰ª£Á†Å">
                                    <el-input v-model="formConfig.mainClass.secCode" placeholder="zssh000016"></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="ÈõÜÂêàÂêçÁß∞">
                                    <el-input v-model="formConfig.mainClass.collectionName" placeholder="zssh000016"></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8" v-if="needsPagesConfig">
                                <el-form-item label="ÂºÄÂßãÈ°µ">
                                    <el-input-number v-model="formConfig.mainClass.pages_start" :min="1" placeholder="ÂºÄÂßãÈ°µ" style="width: 100%;"></el-input-number>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8" v-if="needsPagesConfig">
                                <el-form-item label="ÁªìÊùüÈ°µ">
                                    <el-input-number v-model="formConfig.mainClass.pages_end" :min="1" placeholder="ÁªìÊùüÈ°µ" style="width: 100%;"></el-input-number>
                                </el-form-item>
                            </el-col>
                        </el-row>
                    </el-card>
                    
                    <!-- Â∏ñÂ≠êÁà¨Ëô´ÈÖçÁΩÆ -->
                    <el-card shadow="never" style="margin-bottom: 20px;" v-if="needsPostConfig">
                        <template #header>
                            <span>Â∏ñÂ≠êÁà¨Ëô´ÈÖçÁΩÆ</span>
                        </template>
                        <el-row :gutter="20">
                            <el-col :span="8">
                                <el-form-item label="Á∫øÁ®ãÊï∞">
                                    <el-input-number v-model="formConfig.PostCrawler.thread_num" :min="1" :max="20" style="width: 100%;"></el-input-number>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="Ëµ∑ÂßãÈ°µ">
                                    <el-input-number v-model="formConfig.PostCrawler.start_page" :min="1" style="width: 100%;"></el-input-number>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="ÁªìÊùüÈ°µ">
                                    <el-input-number v-model="formConfig.PostCrawler.end_page" :min="1" style="width: 100%;"></el-input-number>
                                </el-form-item>
                            </el-col>
                        </el-row>
                    </el-card>
                    
                    <!-- ËØÑËÆ∫Áà¨Ëô´ÈÖçÁΩÆ -->
                    <el-card shadow="never" style="margin-bottom: 20px;" v-if="needsCommentConfig">
                        <template #header>
                            <span>ËØÑËÆ∫Áà¨Ëô´ÈÖçÁΩÆ</span>
                        </template>
                        <el-row :gutter="20">
                            <el-col :span="6">
                                <el-form-item label="ÂêØÁî®">
                                    <el-switch v-model="formConfig.CommentCrawler.enabled"></el-switch>
                                </el-form-item>
                            </el-col>
                            <el-col :span="6">
                                <el-form-item label="Êó†Â§¥Ê®°Âºè">
                                    <el-switch v-model="formConfig.CommentCrawler.headless"></el-switch>
                                </el-form-item>
                            </el-col>
                            <el-col :span="6">
                                <el-form-item label="Á≠âÂæÖË∂ÖÊó∂(Áßí)">
                                    <el-input-number v-model="formConfig.CommentCrawler.wait_timeout" :min="1" :max="60" style="width: 100%;"></el-input-number>
                                </el-form-item>
                            </el-col>
                            <el-col :span="6">
                                <el-form-item label="ÊúÄÂ§ßÈáçËØï">
                                    <el-input-number v-model="formConfig.CommentCrawler.max_retry" :min="1" :max="10" style="width: 100%;"></el-input-number>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row :gutter="20">
                            <el-col :span="12">
                                <el-form-item label="ÂºÄÂßãÊó•Êúü">
                                    <el-date-picker v-model="formConfig.CommentCrawler.start_date" type="date" placeholder="ÈÄâÊã©ÂºÄÂßãÊó•Êúü" style="width: 100%;"></el-date-picker>
                                </el-form-item>
                            </el-col>
                            <el-col :span="12">
                                <el-form-item label="ÁªìÊùüÊó•Êúü">
                                    <el-date-picker v-model="formConfig.CommentCrawler.end_date" type="date" placeholder="ÈÄâÊã©ÁªìÊùüÊó•Êúü" style="width: 100%;"></el-date-picker>
                                </el-form-item>
                            </el-col>
                        </el-row>
                    </el-card>
                    
                    <!-- ‰ª£ÁêÜÈÖçÁΩÆ -->
                    <el-card shadow="never" style="margin-bottom: 20px;">
                        <template #header>
                            <span>‰ª£ÁêÜÈÖçÁΩÆ (ÂèØÈÄâ)</span>
                        </template>
                        <el-row :gutter="20">
                            <el-col :span="8">
                                <el-form-item label="ÂêØÁî®‰ª£ÁêÜ">
                                    <el-switch v-model="formConfig.proxies.enabled" @change="onProxyToggle"></el-switch>
                                </el-form-item>
                            </el-col>
                            <el-col :span="16">
                                <el-form-item label="‰ª£ÁêÜÈößÈÅì" v-if="formConfig.proxies.enabled">
                                    <el-input v-model="formConfig.proxies.tunnel" placeholder="i485.kdltpspro.com:15818"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                    </el-card>
                </div>
                
                <!-- JSONÊ®°ÂºèÈÖçÁΩÆ -->
                <el-form-item v-if="configMode === 'json'" label="ÈÖçÁΩÆÊï∞ÊçÆ" required>
                    <el-input 
                        v-model="configFormJson" 
                        type="textarea" 
                        :rows="15" 
                        placeholder="ËØ∑ËæìÂÖ•JSONÊ†ºÂºèÁöÑÈÖçÁΩÆÊï∞ÊçÆ"
                        class="json-editor"
                    ></el-input>
                    <div style="margin-top: 10px; font-size: 12px; color: #909399;">
                        ÊèêÁ§∫ÔºöÈÖçÁΩÆÊï∞ÊçÆÂ∫îÂåÖÂê´MongoDB„ÄÅRedis„ÄÅÁà¨Ëô´ÂèÇÊï∞Á≠â‰ø°ÊÅØ
                    </div>
                </el-form-item>
            </el-form>
            
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="handleCloseConfigDialog">ÂèñÊ∂à</el-button>
                    <el-button type="primary" @click="saveConfig">‰øùÂ≠ò</el-button>
                </span>
            </template>
        </el-dialog>
        
        <!-- Êó•ÂøóÊü•ÁúãÂØπËØùÊ°Ü -->
        <el-dialog 
            v-model="showLogDialog" 
            title="‰ªªÂä°Êó•Âøó" 
            width="80%" 
            :before-close="closeLogDialog"
        >
            <div v-loading="logLoading" style="min-height: 400px;">
                <pre v-if="currentTaskLog" style="background: #f5f5f5; padding: 15px; border-radius: 4px; max-height: 500px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;">{{ currentTaskLog }}</pre>
                <div v-else-if="!logLoading" style="text-align: center; color: #999; padding: 50px;">
                    ÊöÇÊó†Êó•ÂøóÊï∞ÊçÆ
                </div>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="closeLogDialog">ÂÖ≥Èó≠</el-button>
                    <el-button type="primary" @click="viewTaskLog(currentTaskId)" :loading="logLoading">Âà∑Êñ∞Êó•Âøó</el-button>
                </span>
            </template>
        </el-dialog>
        
        <!-- ÂàõÂª∫Êñá‰ª∂Â§πÂØπËØùÊ°Ü -->
        <el-dialog 
            v-model="showCreateFolderDialog" 
            title="ÂàõÂª∫Êñá‰ª∂Â§π" 
            width="400px"
            :before-close="handleCloseFolderDialog"
        >
            <el-form :model="folderForm" label-width="80px">
                <el-form-item label="Êñá‰ª∂Â§πÂêç" required>
                    <el-input 
                        v-model="folderForm.name" 
                        placeholder="ËØ∑ËæìÂÖ•Êñá‰ª∂Â§πÂêçÁß∞ÔºàÂ¶ÇÔºö‰∏äËØÅ501Ôºâ"
                        maxlength="50"
                        show-word-limit
                    ></el-input>
                    <div style="margin-top: 8px; font-size: 12px; color: #909399;">
                        üí° ÊèêÁ§∫Ôºö‰ªªÂä°‰ºöÊ†πÊçÆÂêçÁß∞ÂâçÁºÄËá™Âä®ÂΩíÁ±ªÂà∞ÂØπÂ∫îÊñá‰ª∂Â§π
                    </div>
                </el-form-item>
                <el-form-item label="ÊèèËø∞">
                    <el-input 
                        v-model="folderForm.description" 
                        type="textarea" 
                        :rows="2"
                        placeholder="ËØ∑ËæìÂÖ•Êñá‰ª∂Â§πÊèèËø∞ÔºàÂèØÈÄâÔºâ"
                        maxlength="200"
                        show-word-limit
                    ></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="handleCloseFolderDialog">ÂèñÊ∂à</el-button>
                    <el-button type="primary" @click="createFolder" :disabled="!folderForm.name.trim()">ÂàõÂª∫</el-button>
                </span>
            </template>
        </el-dialog>
    </div>
    
    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        
        // ËÆæÁΩÆaxiosÈªòËÆ§ÈÖçÁΩÆ
        const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
        if (token) {
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        } else {
            // Â¶ÇÊûúÊ≤°ÊúâtokenÔºåÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢
            window.location.href = '/static/login.html';
        }
        
        // Ê∑ªÂä†ÂìçÂ∫îÊã¶Êà™Âô®Â§ÑÁêÜËÆ§ËØÅÈîôËØØ
        axios.interceptors.response.use(
            response => response,
            error => {
                if (error.response && error.response.status === 401) {
                    localStorage.removeItem('auth_token');
                    sessionStorage.removeItem('auth_token');
                    ElMessage.error('ÁôªÂΩïÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                    setTimeout(() => {
                        window.location.href = '/static/login.html';
                    }, 1500);
                }
                return Promise.reject(error);
            }
        );
        
        createApp({
            data() {
                return {
                    currentUser: '',
                    activeTab: 'configs',
                    loading: {
                        configs: false,
                        queue: false,
                        history: false
                    },
                    systemStatus: {
                        scheduler_running: false,
                        current_task: null,
                        queue_stats: {},
                        today_stats: {}
                    },
                    fullTextStatus: {
                        is_running: false,
                        queue_count: 0,
                        progress: '0.0'
                    },
                    taskConfigs: [],
                    taskQueue: [],
                    taskHistory: {
                        items: [],
                        total: 0
                    },
                    historyPage: 1,
                    historyLimit: 20,
                    // Êñá‰ª∂Â§πÁõ∏ÂÖ≥Êï∞ÊçÆ
                    taskFolders: [],
                    selectedFolder: null,
                    showCreateFolderDialog: false,
                    folderForm: {
                        name: '',
                        description: ''
                    },
                    showCreateConfigDialog: false,
                    editingConfig: null,
                    configForm: {
                        task_name: '',
                        description: '',
                        crawler_type: '',
                        priority: 0,
                        enable_parallelism: false,
                        config_data: {}
                    },
                    configFormJson: '',
                    configMode: 'form', // 'form' Êàñ 'json'
                    showLogDialog: false,
                    currentTaskLog: '',
                    currentTaskId: null,
                    logLoading: false,
                    formConfig: {
                        MongoDB: {
                            host: 'localhost',
                            port: 27017,
                            username: 'admin',
                            password: 'aa20020320',
                            database: 'guba'
                        },
                        Redis: {
                            redis_host: 'localhost',
                            redis_port: 6379,
                            redis_password: '123456',
                            redis_db: 0,
                            redis_key: 'urls'
                        },
                        mainClass: {
                            secCode: 'zssh000016',
                            collectionName: 'zssh000016',
                            pages_start: 1,
                            pages_end: 10
                        },
                        PostCrawler: {
                            thread_num: 4,
                            start_page: 1,
                            end_page: 10
                        },
                        CommentCrawler: {
                            enabled: true,
                            headless: false,
                            wait_timeout: 10,
                            max_retry: 3,
                            start_date: '',
                            end_date: ''
                        },
                        proxies: {
                            enabled: false,
                            tunnel: ''
                        }
                     },
                     defaultConfigs: {
                        post: {
                            MongoDB: {
                                host: 'localhost',
                                port: 27017,
                                username: 'admin',
                                password: 'aa20020320',
                                database: 'guba'
                            },
                            Redis: {
                                redis_host: 'localhost',
                                redis_port: 6379,
                                redis_password: '123456',
                                redis_db: 0,
                                redis_key: 'urls'
                            },
                            mainClass: {
                                pages_start: 1,
                                pages_end: 10,
                                secCode: 'zssh000016',
                                collectionName: 'zssh000016'
                            },
                            PostCrawler: {
                                thread_num: 4,
                                start_page: 1,
                                end_page: 10
                            },
                            proxies: {
                                enabled: true,
                                tunnel: 'i485.kdltpspro.com:15818'
                            }
                        },
                        comment: {
                            MongoDB: {
                                host: 'localhost',
                                port: 27017,
                                username: 'admin',
                                password: 'aa20020320',
                                database: 'guba'
                            },
                            Redis: {
                                redis_host: 'localhost',
                                redis_port: 6379,
                                redis_password: '123456',
                                redis_db: 0,
                                redis_key: 'urls'
                            },
                            mainClass: {
                                secCode: 'zssh000016',
                                collectionName: 'zssh000016'
                            },
                            CommentCrawler: {
                                enabled: true,
                                headless: false,
                                wait_timeout: 10,
                                max_retry: 3,
                                start_date: '',
                                end_date: ''
                            }
                        }
                    }
                }
            },
            computed: {
                needsPagesConfig() {
                    return ['post', 'sequential', 'parallel'].includes(this.configForm.crawler_type);
                },
                needsPostConfig() {
                    return ['post', 'sequential', 'parallel'].includes(this.configForm.crawler_type);
                },
                needsCommentConfig() {
                    return ['comment', 'sequential', 'parallel'].includes(this.configForm.crawler_type);
                },
                // Ê†πÊçÆÈÄâ‰∏≠ÁöÑÊñá‰ª∂Â§πËøáÊª§‰ªªÂä°
                filteredTaskConfigs() {
                    if (this.selectedFolder === null) {
                        return this.taskConfigs;
                    }
                    return this.taskConfigs.filter(task => task.folder_id === this.selectedFolder);
                }
            },
            mounted() {
                this.getCurrentUser();
                this.loadSystemStatus();
                this.loadTaskConfigs();
                this.loadTaskFolders();
                
                // ÂÆöÊó∂Âà∑Êñ∞Á≥ªÁªüÁä∂ÊÄÅ
                setInterval(() => {
                    this.loadSystemStatus();
                    this.loadFullTextStatus();
                    if (this.activeTab === 'queue') {
                        this.loadTaskQueue();
                    }
                }, 5000);
                
                // ÂàùÂßãÂä†ËΩΩÂÖ®ÊñáÁà¨ÂèñÂô®Áä∂ÊÄÅ
                this.loadFullTextStatus();
            },
            methods: {
                async getCurrentUser() {
                    try {
                        const response = await axios.get('/api/auth/verify');
                        if (response.data.success) {
                            this.currentUser = response.data.data.username;
                        }
                    } catch (error) {
                        console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error);
                    }
                },
                
                logout() {
                    localStorage.removeItem('auth_token');
                    sessionStorage.removeItem('auth_token');
                    ElMessage.success('Â∑≤ÈÄÄÂá∫ÁôªÂΩï');
                    setTimeout(() => {
                        window.location.href = '/static/login.html';
                    }, 1000);
                },
                
                async loadSystemStatus() {
                    try {
                        const response = await axios.get('/api/tasks/status');
                        if (response.data.success) {
                            this.systemStatus = response.data.data;
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩÁ≥ªÁªüÁä∂ÊÄÅÂ§±Ë¥•:', error);
                    }
                },
                
                async loadTaskConfigs() {
                    this.loading.configs = true;
                    try {
                        const response = await axios.get('/api/tasks/configs');
                        if (response.data.success) {
                            this.taskConfigs = response.data.data;
                            
                            // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÊñá‰ª∂Â§πÂàÜÈÖç‰ø°ÊÅØ
                            const savedConfigs = localStorage.getItem('taskConfigs');
                            if (savedConfigs) {
                                const localConfigs = JSON.parse(savedConfigs);
                                this.taskConfigs.forEach(task => {
                                    const localTask = localConfigs.find(t => t.id === task.id);
                                    if (localTask && localTask.folder_id) {
                                        task.folder_id = localTask.folder_id;
                                    }
                                });
                            }
                        }
                    } catch (error) {
                        ElMessage.error('Âä†ËΩΩ‰ªªÂä°ÈÖçÁΩÆÂ§±Ë¥•: ' + error.message);
                    } finally {
                        this.loading.configs = false;
                    }
                },
                
                async loadTaskQueue() {
                    this.loading.queue = true;
                    try {
                        const response = await axios.get('/api/tasks/queue');
                        if (response.data.success) {
                            // ‰øÆÊîπËøôÈáåÔºöÊ≠£Á°ÆÊèêÂèñqueue_tasksÊï∞ÁªÑ
                            this.taskQueue = response.data.data.queue_tasks || [];
                            // ÂèØ‰ª•ÂêåÊó∂‰øùÂ≠òÂÖ∂‰ªñÊúâÁî®‰ø°ÊÅØ
                            this.queueInfo = {
                                currentRunning: response.data.data.current_running,
                                pendingCount: response.data.data.pending_count,
                                totalInQueue: response.data.data.total_in_queue,
                                schedulerStatus: response.data.data.scheduler_status
                            };
                            console.log('‰ªªÂä°ÈòüÂàóÂä†ËΩΩÊàêÂäü:', this.taskQueue);
                        } else {
                            ElMessage.error('Âä†ËΩΩ‰ªªÂä°ÈòüÂàóÂ§±Ë¥•: ' + response.data.message);
                            this.taskQueue = [];
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩ‰ªªÂä°ÈòüÂàóÈîôËØØ:', error);
                        ElMessage.error('Âä†ËΩΩ‰ªªÂä°ÈòüÂàóÂ§±Ë¥•: ' + error.message);
                        this.taskQueue = [];
                    } finally {
                        this.loading.queue = false;
                    }
                },
                
                async loadTaskHistory() {
                    this.loading.history = true;
                    try {
                        const response = await axios.get('/api/tasks/history', {
                            params: {
                                page: this.historyPage,
                                limit: this.historyLimit
                            }
                        });
                        if (response.data.success) {
                            this.taskHistory = response.data.data;
                        }
                    } catch (error) {
                        ElMessage.error('Âä†ËΩΩ‰ªªÂä°ÂéÜÂè≤Â§±Ë¥•: ' + error.message);
                    } finally {
                        this.loading.history = false;
                    }
                },
                
                async toggleScheduler() {
                    try {
                        const action = this.systemStatus.scheduler_running ? 'stop' : 'start';
                        const response = await axios.post(`/api/scheduler/${action}`);
                        if (response.data.success) {
                            ElMessage.success(response.data.message);
                            this.loadSystemStatus();
                        }
                    } catch (error) {
                        ElMessage.error('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
                    }
                },
                
                async loadFullTextStatus() {
                    try {
                        const response = await axios.get('/api/fulltext/status');
                        if (response.data.success) {
                            this.fullTextStatus = response.data.data;
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩÂÖ®ÊñáÁà¨ÂèñÂô®Áä∂ÊÄÅÂ§±Ë¥•:', error);
                    }
                },
                
                async toggleFullTextCrawler() {
                    try {
                        const action = this.fullTextStatus.is_running ? 'stop' : 'start';
                        const response = await axios.post(`/api/fulltext/${action}`);
                        if (response.data.success) {
                            ElMessage.success(response.data.message);
                            this.loadFullTextStatus();
                        }
                    } catch (error) {
                        ElMessage.error('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
                    }
                },
                
                handleTabClick(tab) {
                    if (tab.name === 'queue') {
                        this.loadTaskQueue();
                    } else if (tab.name === 'history') {
                        this.loadTaskHistory();
                    }
                },
                
                editConfig(config) {
                    this.editingConfig = config;
                    this.configForm = {
                        task_name: config.task_name,
                        description: config.description,
                        crawler_type: config.crawler_type,
                        priority: config.priority
                    };
                    
                    // Ëé∑ÂèñÈÖçÁΩÆÊï∞ÊçÆ
                    axios.get(`/api/tasks/configs/${config.id}/data`).then(response => {
                        if (response.data.success) {
                            this.configFormJson = JSON.stringify(response.data.data, null, 2);
                            // Â∞ùËØïÂ∞ÜJSONÊï∞ÊçÆÂ°´ÂÖÖÂà∞Ë°®Âçï
                            this.populateFormFromJson(response.data.data);
                        }
                    }).catch(() => {
                        this.configFormJson = '{}';
                    });
                    
                    this.showCreateConfigDialog = true;
                },
                
                onCrawlerTypeChange(type) {
                    if (this.defaultConfigs[type] && !this.editingConfig) {
                        if (this.configMode === 'json') {
                            this.configFormJson = JSON.stringify(this.defaultConfigs[type], null, 2);
                        } else {
                            this.populateFormFromJson(this.defaultConfigs[type]);
                        }
                    }
                },
                
                onConfigModeChange(mode) {
                    if (mode === 'json') {
                        // ‰ªéË°®ÂçïÊ®°ÂºèÂàáÊç¢Âà∞JSONÊ®°ÂºèÔºåÂ∞ÜË°®ÂçïÊï∞ÊçÆËΩ¨Êç¢‰∏∫JSON
                        this.configFormJson = JSON.stringify(this.buildConfigFromForm(), null, 2);
                    } else {
                        // ‰ªéJSONÊ®°ÂºèÂàáÊç¢Âà∞Ë°®ÂçïÊ®°ÂºèÔºåÂ∞ÜJSONÊï∞ÊçÆÂ°´ÂÖÖÂà∞Ë°®Âçï
                        try {
                            const jsonData = JSON.parse(this.configFormJson || '{}');
                            this.populateFormFromJson(jsonData);
                        } catch (e) {
                            console.warn('JSONÊ†ºÂºèÈîôËØØÔºå‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ');
                        }
                    }
                },
                
                populateFormFromJson(data) {
                    // Ê∑±Â∫¶ÂêàÂπ∂ÈÖçÁΩÆÊï∞ÊçÆÂà∞Ë°®Âçï
                    if (data.MongoDB) {
                        Object.assign(this.formConfig.MongoDB, data.MongoDB);
                    }
                    if (data.Redis) {
                        Object.assign(this.formConfig.Redis, data.Redis);
                    }
                    if (data.mainClass) {
                        Object.assign(this.formConfig.mainClass, data.mainClass);
                    }
                    if (data.PostCrawler) {
                        Object.assign(this.formConfig.PostCrawler, data.PostCrawler);
                    }
                    if (data.CommentCrawler) {
                        Object.assign(this.formConfig.CommentCrawler, data.CommentCrawler);
                        // Â§ÑÁêÜÊó•ÊúüÊ†ºÂºè
                        if (data.CommentCrawler.start_date) {
                            this.formConfig.CommentCrawler.start_date = new Date(data.CommentCrawler.start_date);
                        }
                        if (data.CommentCrawler.end_date) {
                            this.formConfig.CommentCrawler.end_date = new Date(data.CommentCrawler.end_date);
                        }
                    }
                    if (data.proxies) {
                        Object.assign(this.formConfig.proxies, data.proxies);
                    }
                },
                
                buildConfigFromForm() {
                    const config = {
                        MongoDB: { ...this.formConfig.MongoDB },
                        Redis: { ...this.formConfig.Redis },
                        mainClass: { ...this.formConfig.mainClass },
                        proxies: { ...this.formConfig.proxies }
                    };
                    
                    // Ê†πÊçÆÁà¨Ëô´Á±ªÂûãÊ∑ªÂä†Áõ∏Â∫îÈÖçÁΩÆ
                    if (this.needsPostConfig) {
                        config.PostCrawler = { ...this.formConfig.PostCrawler };
                    }
                    
                    if (this.needsCommentConfig) {
                        config.CommentCrawler = { ...this.formConfig.CommentCrawler };
                        // Â§ÑÁêÜÊó•ÊúüÊ†ºÂºè
                        if (config.CommentCrawler.start_date) {
                            config.CommentCrawler.start_date = this.formatDate(config.CommentCrawler.start_date);
                        }
                        if (config.CommentCrawler.end_date) {
                            config.CommentCrawler.end_date = this.formatDate(config.CommentCrawler.end_date);
                        }
                    }
                    
                    // Ê∏ÖÁêÜÁ©∫ÂÄºÊàñÁ¶ÅÁî®ÁöÑ‰ª£ÁêÜÈÖçÁΩÆ
                    if (!config.proxies.enabled || !config.proxies.tunnel) {
                        delete config.proxies;
                    }
                    
                    return config;
                },
                
                onProxyToggle(enabled) {
                    if (!enabled) {
                        this.formConfig.proxies.tunnel = '';
                    }
                },
                
                formatDate(date) {
                    if (!date) return '';
                    if (typeof date === 'string') return date;
                    return date.toISOString().split('T')[0];
                },
                
                async saveConfig() {
                    try {
                        let configData;
                        
                        if (this.configMode === 'form') {
                            // Ë°®ÂçïÊ®°ÂºèÔºö‰ªéË°®ÂçïÊûÑÂª∫ÈÖçÁΩÆÊï∞ÊçÆ
                            configData = this.buildConfigFromForm();
                        } else {
                            // JSONÊ®°ÂºèÔºöÈ™åËØÅJSONÊ†ºÂºè
                            try {
                                configData = JSON.parse(this.configFormJson);
                            } catch (e) {
                                ElMessage.error('ÈÖçÁΩÆÊï∞ÊçÆÊ†ºÂºèÈîôËØØÔºåËØ∑Ê£ÄÊü•JSONÊ†ºÂºè');
                                return;
                            }
                
                        }
                        
                        const data = {
                            ...this.configForm,
                            config_data: configData
                        };
                        
                        let response;
                        if (this.editingConfig) {
                            response = await axios.put(`/api/tasks/configs/${this.editingConfig.id}`, data);
                        } else {
                            response = await axios.post('/api/tasks/configs', data);
                        }
                        
                        if (response.data.success) {
                            ElMessage.success(this.editingConfig ? 'Êõ¥Êñ∞ÊàêÂäü' : 'ÂàõÂª∫ÊàêÂäü');
                            this.handleCloseConfigDialog();
                            this.$nextTick(() => {
                                this.loadTaskConfigs();
                            });
                        }
                    } catch (error) {
                        ElMessage.error('‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
                    }
                },
                
                handleCloseConfigDialog() {
                    this.showCreateConfigDialog = false;
                    this.editingConfig = null;
                    this.configForm = {
                        task_name: '',
                        description: '',
                        crawler_type: '',
                        priority: 0,
                        enable_parallelism: false
                    };
                    this.configFormJson = '';
                    this.configMode = 'form';
                    // ÈáçÁΩÆË°®ÂçïÈÖçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº
                    this.formConfig = {
                        MongoDB: {
                            host: 'localhost',
                            port: 27017,
                            username: 'admin',
                            password: 'aa20020320',
                            database: 'guba'
                        },
                        Redis: {
                            redis_host: 'localhost',
                            redis_port: 6379,
                            redis_password: '123456',
                            redis_db: 0,
                            redis_key: 'urls'
                        },
                        mainClass: {
                            secCode: 'zssh000016',
                            collectionName: 'zssh000016',
                            pages_start: 1,
                            pages_end: 10
                        },
                        PostCrawler: {
                            thread_num: 4,
                            start_page: 1,
                            end_page: 10
                        },
                        CommentCrawler: {
                            enabled: true,
                            headless: false,
                            wait_timeout: 10,
                            max_retry: 3,
                            start_date: '',
                            end_date: ''
                        },
                        proxies: {
                            enabled: false,
                            tunnel: ''
                        }
                    };
                },
                
                async deleteConfig(configId) {
                    try {
                        await ElMessageBox.confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰ªªÂä°ÈÖçÁΩÆÂêóÔºü', 'Á°ÆËÆ§Âà†Èô§', {
                            type: 'warning'
                        });
                        
                        const response = await axios.delete(`/api/tasks/configs/${configId}`);
                        if (response.data.success) {
                            ElMessage.success('Âà†Èô§ÊàêÂäü');
                            this.loadTaskConfigs();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('Âà†Èô§Â§±Ë¥•: ' + error.message);
                        }
                    }
                },
                
                async addToQueue(configId) {
                    try {
                        const response = await axios.post('/api/tasks/queue', {
                            task_config_id: configId
                        });
                        if (response.data.success) {
                            ElMessage.success('Â∑≤Ê∑ªÂä†Âà∞ÈòüÂàó');
                            this.loadTaskQueue();
                        }
                    } catch (error) {
                        ElMessage.error('Ê∑ªÂä†Âà∞ÈòüÂàóÂ§±Ë¥•: ' + error.message);
                    }
                },
                
                async removeFromQueue(queueId) {
                    try {
                        await ElMessageBox.confirm('Á°ÆÂÆöË¶Å‰ªéÈòüÂàó‰∏≠ÁßªÈô§Ëøô‰∏™‰ªªÂä°ÂêóÔºü', 'Á°ÆËÆ§ÁßªÈô§', {
                            type: 'warning'
                        });
                        
                        const response = await axios.delete(`/api/tasks/queue/${queueId}`);
                        if (response.data.success) {
                            ElMessage.success('Â∑≤‰ªéÈòüÂàóÁßªÈô§');
                            this.loadTaskQueue();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('ÁßªÈô§Â§±Ë¥•: ' + error.message);
                        }
                    }
                },
                
                getCrawlerTypeColor(type) {
                    const colors = {
                        post: 'primary',
                        comment: 'success',
                        full_text: 'warning',
                        sequential: 'info',
                        parallel: 'danger'
                    };
                    return colors[type] || 'default';
                },
                
                getCrawlerTypeName(type) {
                    const names = {
                        post: 'Â∏ñÂ≠êÁà¨Âèñ',
                        comment: 'ËØÑËÆ∫Áà¨Âèñ',
                        full_text: 'ÂÖ®ÊñáÁà¨Âèñ',
                        sequential: 'È°∫Â∫èÊâßË°å',
                        parallel: 'Âπ∂Ë°åÊâßË°å'
                    };
                    return names[type] || type;
                },
                
                getStatusName(status) {
                    const names = {
                        pending: 'Á≠âÂæÖ‰∏≠',
                        running: 'ËøêË°å‰∏≠',
                        completed: 'Â∑≤ÂÆåÊàê',
                        failed: 'Â§±Ë¥•',
                        cancelled: 'Â∑≤ÂèñÊ∂à'
                    };
                    return names[status] || status;
                },
                
                formatDateTime(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    
    // ÊâãÂä®Â∞ÜÊó†Êó∂Âå∫ÁöÑÊó∂Èó¥ËßÜ‰∏∫ UTC Êó∂Èó¥
    const localDate = new Date(date.getTime() + date.getTimezoneOffset() * 60000);
    return localDate.toLocaleString('zh-CN');
},
formatDateTime2(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    
    // Â¢ûÂä†8Â∞èÊó∂Ôºà‰∏úÂÖ´Âå∫Êó∂Èó¥Ôºâ
    const utc8Time = date.getTime() //+ 8 * 3600 * 1000;
    const utc8Date = new Date(utc8Time);
    
    return utc8Date.toLocaleString('zh-CN');
},
                
                formatDuration(seconds) {
                    if (!seconds) return '0Áßí';
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    
                    if (hours > 0) {
                        return `${hours}Â∞èÊó∂${minutes}ÂàÜÈíü${secs}Áßí`;
                    } else if (minutes > 0) {
                        return `${minutes}ÂàÜÈíü${secs}Áßí`;
                    } else {
                        return `${secs}Áßí`;
                    }
                },
                
                async viewTaskLog(taskId) {
                    this.currentTaskId = taskId;
                    this.showLogDialog = true;
                    this.logLoading = true;
                    this.currentTaskLog = '';
                    
                    try {
                        const response = await axios.get(`/api/tasks/${taskId}/logs`);
                        if (response.data.success) {
                            this.currentTaskLog = response.data.data.logs || 'ÊöÇÊó†Êó•ÂøóÂÜÖÂÆπ';
                        } else {
                            this.currentTaskLog = 'Ëé∑ÂèñÊó•ÂøóÂ§±Ë¥•: ' + response.data.message;
                        }
                    } catch (error) {
                        this.currentTaskLog = 'Ëé∑ÂèñÊó•ÂøóÂ§±Ë¥•: ' + error.message;
                    } finally {
                        this.logLoading = false;
                    }
                },
                
                closeLogDialog() {
                    this.showLogDialog = false;
                    this.currentTaskLog = '';
                    this.currentTaskId = null;
                },
                
                // Êñá‰ª∂Â§πÁõ∏ÂÖ≥ÊñπÊ≥ï
                async loadTaskFolders() {
                    try {
                        // Ê®°Êãü‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÊñá‰ª∂Â§πÊï∞ÊçÆ
                        const folders = localStorage.getItem('taskFolders');
                        this.taskFolders = folders ? JSON.parse(folders) : [];
                    } catch (error) {
                        console.error('Âä†ËΩΩÊñá‰ª∂Â§πÂ§±Ë¥•:', error);
                        this.taskFolders = [];
                    }
                },
                
                openCreateFolderDialog() {
                    this.showCreateFolderDialog = true;
                    this.folderForm = {
                        name: '',
                        description: ''
                    };
                },
                
                async createFolder() {
                    if (!this.folderForm.name.trim()) {
                        ElMessage.error('ËØ∑ËæìÂÖ•Êñá‰ª∂Â§πÂêçÁß∞');
                        return;
                    }
                    
                    try {
                        const newFolder = {
                            id: Date.now().toString(),
                            name: this.folderForm.name.trim(),
                            description: this.folderForm.description.trim(),
                            created_at: new Date().toISOString()
                        };
                        
                        this.taskFolders.push(newFolder);
                        
                        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                        localStorage.setItem('taskFolders', JSON.stringify(this.taskFolders));
                        
                        ElMessage.success('Êñá‰ª∂Â§πÂàõÂª∫ÊàêÂäü');
                        this.showCreateFolderDialog = false;
                        
                        // Ëá™Âä®ÂΩíÁ±ªÁé∞Êúâ‰ªªÂä°
                        this.autoClassifyTasks();
                        
                    } catch (error) {
                        ElMessage.error('ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•: ' + error.message);
                    }
                },
                
                async deleteFolder(folderId) {
                    try {
                        await ElMessageBox.confirm('Âà†Èô§Êñá‰ª∂Â§πÂêéÔºåÂÖ∂‰∏≠ÁöÑ‰ªªÂä°Â∞ÜÂèò‰∏∫Êú™ÂàÜÁ±ªÁä∂ÊÄÅ„ÄÇÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü', 'Á°ÆËÆ§Âà†Èô§', {
                            type: 'warning'
                        });
                        
                        // Â∞ÜËØ•Êñá‰ª∂Â§π‰∏≠ÁöÑ‰ªªÂä°ËÆæ‰∏∫Êú™ÂàÜÁ±ª
                        this.taskConfigs.forEach(task => {
                            if (task.folder_id === folderId) {
                                task.folder_id = null;
                            }
                        });
                        
                        // Âà†Èô§Êñá‰ª∂Â§π
                        this.taskFolders = this.taskFolders.filter(folder => folder.id !== folderId);
                        
                        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                        localStorage.setItem('taskFolders', JSON.stringify(this.taskFolders));
                        localStorage.setItem('taskConfigs', JSON.stringify(this.taskConfigs));
                        
                        // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÊòØË¢´Âà†Èô§ÁöÑÊñá‰ª∂Â§πÔºåÂàáÊç¢Âà∞ÂÖ®ÈÉ®‰ªªÂä°
                        if (this.selectedFolder === folderId) {
                            this.selectedFolder = null;
                        }
                        
                        ElMessage.success('Êñá‰ª∂Â§πÂà†Èô§ÊàêÂäü');
                        
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('Âà†Èô§Êñá‰ª∂Â§πÂ§±Ë¥•: ' + error.message);
                        }
                    }
                },
                
                selectFolder(folderId) {
                    this.selectedFolder = folderId;
                },
                
                getFolderTaskCount(folderId) {
                    return this.taskConfigs.filter(task => task.folder_id === folderId).length;
                },
                
                getFolderName(folderId) {
                    if (!folderId) return 'Êú™ÂàÜÁ±ª';
                    const folder = this.taskFolders.find(f => f.id === folderId);
                    return folder ? folder.name : 'Êú™Áü•Êñá‰ª∂Â§π';
                },
                
                async moveTaskToFolder(taskId, folderId) {
                    try {
                        const task = this.taskConfigs.find(t => t.id === taskId);
                        if (task) {
                            task.folder_id = folderId;
                            
                            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                            localStorage.setItem('taskConfigs', JSON.stringify(this.taskConfigs));
                            
                            ElMessage.success('‰ªªÂä°ÁßªÂä®ÊàêÂäü');
                        }
                    } catch (error) {
                        ElMessage.error('ÁßªÂä®‰ªªÂä°Â§±Ë¥•: ' + error.message);
                    }
                },
                
                autoClassifyTasks() {
                    let classifiedCount = 0;
                    
                    this.taskConfigs.forEach(task => {
                        // Âè™ÂØπÊú™ÂàÜÁ±ªÁöÑ‰ªªÂä°ËøõË°åËá™Âä®ÂΩíÁ±ª
                        if (!task.folder_id) {
                            for (const folder of this.taskFolders) {
                                // Ê£ÄÊü•‰ªªÂä°ÂêçÁß∞ÊòØÂê¶‰ª•Êñá‰ª∂Â§πÂêçÁß∞‰∏∫ÂâçÁºÄ
                                if (task.task_name && task.task_name.startsWith(folder.name)) {
                                    task.folder_id = folder.id;
                                    classifiedCount++;
                                    break;
                                }
                            }
                        }
                    });
                    
                    if (classifiedCount > 0) {
                        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                        localStorage.setItem('taskConfigs', JSON.stringify(this.taskConfigs));
                        ElMessage.success(`Â∑≤Ëá™Âä®ÂΩíÁ±ª ${classifiedCount} ‰∏™‰ªªÂä°`);
                    } else {
                        ElMessage.info('Ê≤°ÊúâÊâæÂà∞ÂèØ‰ª•Ëá™Âä®ÂΩíÁ±ªÁöÑ‰ªªÂä°');
                    }
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
<div class="stage-indicator">
    <div class="stage-step active">
        <span class="stage-icon">üï∑Ô∏è</span> Áà¨Ëô´‰ªªÂä°Ë∞ÉÂ∫¶Á≥ªÁªü
    </div>
    <div class="stage-step completed">
        <span class="stage-icon">‚úîÔ∏è</span> Â∑≤ÂÆåÊàê
    </div>
    <div class="stage-step failed">
        <span class="stage-icon">‚ùå</span> Â§±Ë¥•
    </div>
</div>